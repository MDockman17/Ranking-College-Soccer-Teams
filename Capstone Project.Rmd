---
title: "Capstone Project"
author: "Matt Dockman"
date: "2022-10-25"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
options(warn=-1)
suppressMessages({
library(tidyverse)
library(RPostgres)
library(DBI)
library(tidymodels)
library(caret)
library(pls)
library(calibrate)
library(BAS)
library(BMA)
library(mvtnorm)
library(vip)})
```


```{r}
bring_in_data = function(db = "boost_db_dev_soccer_us", host_db = "52.151.4.240" , db_port = "5432", db_user = "duke_intern", db_password = "I92fdslfsasfh32iUm"){
  
  con = dbConnect(RPostgres::Postgres(), dbname = db, host=host_db, port=db_port, user=db_user, password=db_password)
  
  team_game_stat = dbGetQuery(con,"SELECT * FROM vw_bs_team_game_stat")
  
  team_game = dbGetQuery(con, "SELECT * FROM vw_bs_team_game")
  
  team = dbGetQuery(con, "SELECT * FROM vw_bs_team")
  
  return(list(team_game_stat = team_game_stat, team_game = team_game, team = team))
}

boost_data = bring_in_data()
```

```{r}
join_data = function(team_game_stat, team){
  
   joined_data = left_join(team_game_stat, team, by = "team_id")

   team$opponent_team_id = team$team_id

  joined_data = left_join(joined_data, team, by =   "opponent_team_id")

  womens = joined_data %>% 
  filter(league_name.x == "NCAA WOMEN SOCCER",   division_name.x == "D-I", division_name.y == "D-I")

  mens = joined_data %>%
  filter(league_name.x == "NCAA MEN SOCCER",
division_name.x == "D-I",division_name.y == "D-I")
  
  return(list(womens = womens,mens = mens))
}

team_game_stat = boost_data[["team_game_stat"]]
team = boost_data[["team"]]
joined_data = join_data(team_game_stat,team)
```



```{r}


preprocess_data = function(data){
  
  for(j in 1:length(data)){
    
    df = data[[j]]
    
    variables = c("season_year", "date", "team_game_number","opponent_team_game_number", "game_id", "team_id.x","team_name.x", "team_market.x", "team_conference_id", "team_id.y", "team_name", "team_market", "location_type", "goal_differential","goals","opp_goals","corners","fouls_committed", "fouls_won", "free_kicks", "goal_kicks", "offsides", "red_cards", "yellow_cards", "shots", "shots_on_target", "shots_off_target", "shots_on_target_percentage", "shots_on_wood_work", "shots_saved", "save_percentage", "throw_ins", "opp_corners",   "opp_fouls_committed", "opp_fouls_won", "opp_free_kicks", "opp_goal_kicks", "opp_offsides", "opp_red_cards", "opp_yellow_cards", "opp_shots", "opp_shots_on_target", "opp_shots_off_target", "opp_shots_on_target_percentage", "opp_shots_on_wood_work", "opp_shots_saved", "opp_save_percentage", "opp_throw_ins")
    
    df = df[,variables]
    
    for(i in 1:nrow(df)){

    df$goal_differential[i] = df$goals[i] - df$opp_goals[i]
  
      if(df$goals[i] > df$shots[i]){
    
        df$shots[i] = floor(df$goals[i] + mean(df$shots) - mean(df$goals))
  }
  
      if(df$shots_on_target[i] == 0 & df$shots_off_target[i] == 0){
    df$shots_on_target_percentage[i] = NA
  }
  
      if(df$shots[i] != df$shots_on_target[i] + df$shots_off_target[i] & df$shots_on_target[i] != 0){
    df$shots_off_target[i] = 
      df$shots[i] - df$shots_on_target[i]
  }
  
      if(df$opp_goals[i] > df$opp_shots[i]){
    df$opp_shots[i] = floor(df$opp_goals[i] + mean(df$shots) - mean(df$goals))
  }
  
    if(df$opp_shots_on_target[i] == 0 & df$opp_shots_off_target[i] == 0){
    
      df$opp_shots_on_target_percentage[i] = NA
  }
  
    if(df$opp_shots[i] != df$opp_shots_on_target[i] + df$opp_shots_off_target[i] & df$opp_shots_on_target[i] != 0){
    df$opp_shots_off_target[i] = 
      df$opp_shots[i] - df$opp_shots_on_target[i]
    }
    }
    
    on_target_pct = df %>%
  filter(!is.na(shots_on_target_percentage)) %>%
  summarise(mean = mean(shots_on_target_percentage))
    
    for(i in 1:nrow(df)){
  if(is.na(df$shots_on_target_percentage[i])){
    df$shots_on_target_percentage[i] = on_target_pct$mean
  }
  if(is.na(df$opp_shots_on_target_percentage[i])){
    df$opp_shots_on_target_percentage[i] = on_target_pct$mean
  }
    }
    
    for(i in 1:nrow(df)){
  
      if(df$shots_on_target[i] == 0 &
    df$shots_off_target[i] == 0){
    df$shots_on_target[i] = 
      floor(df$shots_on_target_percentage[i]*df$shots[i])
  }
    df$shots_off_target[i] = df$shots[i] - 
    df$shots_on_target[i]
  
    if(df$opp_shots_on_target[i] == 0 &
    df$opp_shots_off_target[i] == 0){
    df$opp_shots_on_target[i] = 
      floor(df$opp_shots_on_target_percentage[i]*df$opp_shots[i])}
    df$opp_shots_off_target[i] = df$opp_shots[i] - df$opp_shots_on_target[i]
  
    }
    
    df = df %>%
  mutate(shots_saved = opp_shots_on_target - opp_goals,
         opp_shots_saved = shots_on_target -
           goals)

    for(i in 1:nrow(df)){
  
      if(df$opp_shots_on_target[i] > 0){
    df$save_percentage[i] =
      df$shots_saved[i]/df$opp_shots_on_target[i]
  }
  
      if(df$opp_shots_on_target[i] == 0)
  {
    df$save_percentage[i] = 1
  }

  if(df$shots_on_target[i] > 0){
    df$opp_save_percentage[i] =
      df$opp_shots_saved[i]/df$shots_on_target[i]
  }
  if(df$shots_on_target[i] == 0)
  {
    df$opp_save_percentage[i] = 1
  }
  if(df$save_percentage[i] < 0){
    df$save_percentage[i] = 0
  }
  
  if(df$opp_save_percentage[i] < 0){
    df$opp_save_percentage[i] = 0
  }
  
    }

  data[[j]] = df
  }
  return(data)
}

processed_data = preprocess_data(joined_data)
processed_data[["womens"]] = processed_data$womens %>%
  filter(game_id != 6781)


```


```{r}
filter_data = function(data){

  dataframes = list() 
  names = c()
  
  for(i in 1:length(data)){
  
  df = data[[i]]
  years = unique(df$season_year) %>%
    sort()
  league = c("womens_model","mens_model")
  
  for(j in 1:length(years)){
    
  df_temp = df %>%
  filter(season_year == years[j]) %>%
  arrange(date)
  
  dataframes[[length(dataframes) + 1]] = df_temp
  names = append(names, paste0(league[i],"_",years[j]))
   
  }}
  
  names(dataframes) = names
  return(dataframes)
  
}

filtered_data = filter_data(processed_data)

```


```{r}
update_ratings = function(result,prior_rating,opp_prior_rating,prior_volatility, opp_prior_volatility){
  
  ratings_diff = prior_rating - opp_prior_rating

  sd = sqrt(prior_volatility^2 + opp_prior_volatility^2)

    gradient = (1/sd)*(result*dnorm(ratings_diff,sd = sd)/pnorm(ratings_diff,sd = sd)) + (1/sd)*((1-result)*-dnorm(ratings_diff,sd = sd)/(1-pnorm(ratings_diff,sd = sd)))
  
 return(gradient) 
  
}
```


```{r}
update_volatility = function(result,prior_rating,opp_prior_rating,prior_volatility, opp_prior_volatility){
  
 ratings_diff = prior_rating - opp_prior_rating

  sd = sqrt(prior_volatility^2 + opp_prior_volatility^2)

    gradient = (result*-dnorm(ratings_diff,sd = sd)/pnorm(ratings_diff,sd = sd))*(ratings_diff*prior_volatility/(sd^3)) + ((1-result)*dnorm(ratings_diff,sd = sd)/(1-pnorm(ratings_diff,sd = sd)))*(ratings_diff*prior_volatility/(sd^3))
  
 return(gradient) 
  
}
```

```{r}
create_result_and_shot_diff = function(data){
  
  for(j in 1:length(data)){
    
    df = data[[j]]
    
    df = df %>%
      mutate(diff_in_shots = shots - opp_shots)
    
  for(i in 1:nrow(df)){
      
  if(df$goal_differential[i] > 0){
    df$result[i] = 1
  }
  else if(df$goal_differential[i] == 0){
    df$result[i] = 0.5
  }
  else
    df$result[i] = 0
}
    
   data[[j]] = df
    
  }
  
 return(data) 
  
}

data = create_result_and_shot_diff(filtered_data)

```


Fixed one game in which goal differential was calculated incorrectly.
Fixed one game in which shots was below goals.
Removed one game in which all we had was goals scored by each team.
Imputed as goals plus average difference in shots and goals.
Confirmed no observations of shots on target were greater than shots.
Confirmed no observations of shots off target were greater than shots.
1333 games, about 9%, where shots is not equal to shots on target plus shots off target.
For games which had shots and shots on target, filled in shots off target as the difference.
70 games, about 0.5%, where we have 0 shots on target and 0 shots off target, put NA as shot on target percentage. Imputed as overall percentage. From this, extracted shots on target and targets off target. Used these to infer saves and save percentages for both sides.

```{r}

fix_game_numbers = function(data){
  
  for(i in 1:length(data)){
    
    df = data[[i]]
    
    df$team_game_number = as.integer(df$team_game_number)
    
    split_dfs = split(df,df$team_id.x)
    
    for(j in 1:length(split_dfs)){
      df_temp = split_dfs[[j]]
      n = nrow(df_temp)
      df_temp$team_game_number = 1:n
      split_dfs[[j]] = df_temp
    }
    
    df = bind_rows(split_dfs)%>%
  arrange(date)
    
    data[[i]] = df
    
  }
  
  return(data)
  
}

data = fix_game_numbers(data)

```



```{r}
fix_opp_game_numbers = function(data){
  
  for(i in 1:length(data)){
   
   df = data[[i]] 
   
   df$opponent_team_game_number = as.integer(df$opponent_team_game_number)
   
   opponent_game_number = rep(0,nrow(df))  
   
   for(j in 1:length(unique(df$team_id.x))){
  number = 0
      for(k in 1:nrow(df)){
    
    if(df$team_id.y[k] == unique(df$team_id.x)[j]){
      
      number = number + 1
      opponent_game_number[k] = number
    }
  }
}
   df$opponent_team_game_number = opponent_game_number
  
   data[[i]] = df
   
  }
 return(data) 
}

data = fix_opp_game_numbers(data)

```


```{r}
create_baseline_ratings = function(data, hyperparameters, last_year_ratings = NULL){
  
  df = data
  
  season_year = df$season_year[1]
  
  df$rating = 0
  df$prior_rating = 0
  df$opp_prior_rating = 0
  df$win_probability = 0
  df$offensive_rating = 0
  df$defensive_rating = 0
  df$prior_off_rating = 0
  df$prior_def_rating = 0
  df$opp_prior_off_rating = 0
  df$opp_prior_def_rating = 0
  df$update_size = 0
  df$prior_update_size = 0
  
  logit_param = hyperparameters[1]
  update_param = hyperparameters[2]
  
  logistic_function = function(prior_rating, opponent_prior_rating,logit_param){
  prob = 1/(1 + exp(-logit_param*(prior_rating - opponent_prior_rating)))
  return(prob)
}


    for(j in 1:nrow(df)){
  
    team = df$team_market.x[j]
    
    game_number = df$team_game_number[j]
                                      
    opponent = df$team_market[j] 
    
    opponent_game_number =   df$opponent_game_number[j]

if(game_number > 1){
    
  indices = which(df$team_market.x == df$team_market.x[j])

    index = indices[as.integer(game_number-1)]

    prior_rating = df$rating[index]
    
    df$prior_rating[j] = prior_rating
    
    prior_update_size = df$update_size[index]
    
    df$prior_update_size[j] = prior_update_size
    
    prior_offensive_rating = df$offensive_rating[index]
    
    df$prior_off_rating[j] = prior_offensive_rating
    
    prior_defensive_rating = df$defensive_rating[index]
    
    df$prior_def_rating[j] = prior_defensive_rating
}


    
if(game_number == 1 & season_year == 2020){
    prior_rating = 0
    prior_offensive_rating = 1
    prior_defensive_rating = 1
    prior_update_size = 0}
    
if(game_number == 1 & season_year != 2020){
    index = which(last_year_ratings$team_market.x == team)
    if(length(index)==0){
      prior_rating = 0
    }
    else{
    prior_rating = last_year_ratings$final_rating[index]
    df$prior_rating[j] = prior_rating}
    prior_offensive_rating = 1
    prior_defensive_rating = 1
    prior_update_size = 0}

if(opponent_game_number > 1){
    
    opponent_indices = which(df$team_market.x == df$team_market[j])

    opponent_index = opponent_indices[as.integer(opponent_game_number-1)]

    opponent_prior_rating = df$rating[opponent_index]
    
    df$opp_prior_rating[j] = opponent_prior_rating
    
    opponent_prior_offensive_rating = df$offensive_rating[opponent_index]
    
    opponent_prior_defensive_rating = df$defensive_rating[opponent_index]
    
    df$opp_prior_off_rating[j] = opponent_prior_offensive_rating
    
    df$opp_prior_def_rating[j] = opponent_prior_defensive_rating
    
    }
   
if(opponent_game_number == 1 & season_year == 2020){
    opponent_prior_rating = 0
    opponent_prior_offensive_rating = 1
    opponent_prior_defensive_rating = 1
}
    
    if(opponent_game_number == 1 & season_year != 2020){
    opponent_index = which(last_year_ratings$team_market.x == opponent)
    if(length(opponent_index)==0){
      opponent_prior_rating = 0
    }
    else{
    opponent_prior_rating = last_year_ratings$final_rating[opponent_index]
    df$opp_prior_rating[j] = opponent_prior_rating
      }
      opponent_prior_offensive_rating = 1
      opponent_prior_defensive_rating = 1}
  
    result = df$result[j]

    win_probability = logistic_function(prior_rating,opponent_prior_rating,logit_param)
       
    df$win_probability[j] = win_probability
  
  update_size = update_param*(result - win_probability) 
    
    df$rating[j] = prior_rating +
      update_size
  
  df$update_size[j] = update_size
                                 
  goals_scored = df$goals[j]
  
  goals_allowed = df$opp_goals[j]
  
  offensive_update = (sqrt(prior_offensive_rating* opponent_prior_defensive_rating) + goals_scored)/2
  
  df$offensive_rating[j] = offensive_update
  
  defensive_update= (sqrt(prior_defensive_rating*opponent_prior_offensive_rating) + goals_allowed)/2
  
  df$defensive_rating[j] = defensive_update
  
    }
 return(df) 

}

```

```{r}
tune_baseline_hyperparameters = function(data,last_year_ratings = NULL, logit_scale = c(0.25,0.5,0.75,1) , update_scale = c(0.5,1,2,4)){
  
  df = data
  
  three_way_results = c()
  two_way_results = c()
  brier_scores = c()
  mses = c()
  hypers = c()

for(l in 1:length(logit_scale)){
  
for(u in 1:length(update_scale)){
  
  hyperparameters = c(logit_scale[l],update_scale[u])
  
  if(is.null(last_year_ratings)){
  
  df = create_baseline_ratings(df,hyperparameters)}
  
  else{
    
  df = create_baseline_ratings(df,hyperparameters,last_year_ratings)
  }
  
  performance = get_performance_measures(df)
  
  three_way_results = c(three_way_results,performance[1])
  two_way_results = c(two_way_results,performance[2])
  brier_scores = c(brier_scores,performance[3])
  mses = c(mses, performance[4])
  hypers = c(hypers,paste0(l,u))
  
 
 print(l)
  
  }
}
  
  results = list(twoway = two_way_results,threeway = three_way_results, brier = brier_scores,mses = mses,hyperparameters = hypers)
  
  hyper_index = which.min(results[["mses"]])
  
  tuning_indices = results[["hyperparameters"]][hyper_index]
  
  params_indices = as.integer(strsplit(tuning_indices, split = "")[[1]])
  
logit_param = logit_scale[params_indices[1]]

update_param = update_scale[params_indices[2]]

hyperparameters = c(logit_param,update_param)
  
  return(hyperparameters)  
  }
```


```{r}
run_baseline_model = function(data, league){
  
  if(league == "womens"){
    lower = 1
    upper = (length(data)/2) - 1
  }
  else{
    lower = (length(data)/2) + 1
    upper = length(data) - 1
  }
  
  for(i in lower:upper){
    
    if(i != lower){
      
      hyperparameters = tune_baseline_hyperparameters(data[[i]], final_ratings)
    
    }
   
    if(i == lower){
      
    hyperparameters = tune_baseline_hyperparameters(data[[i]])
    
     data[[i]] =  create_baseline_ratings(data[[i]], hyperparameters$best)
     
     final_ratings = find_final_ratings(data[[i]])
    }
    
    data[[i+1]] = create_baseline_ratings(data[[i+1]], hyperparameters$best, final_ratings)
    
    final_ratings = find_final_ratings(data[[i+1]])
  }
    
   return(data) 
  }
```



```{r}
select_variables = function(data, threshold){
  
    df = data
    
    n = nrow(df)
    
    p = 22
    
    Data_bas = bas.lm(goal_differential ~ corners     + fouls_won  + goal_kicks + offsides + shots +     shots_on_target_percentage + shots_on_wood_work     + shots_saved + throw_ins + save_percentage +      red_cards + opp_corners + opp_fouls_won  +         opp_goal_kicks + opp_offsides + opp_shots +        opp_shots_on_target_percentage +                   opp_shots_on_wood_work + opp_shots_saved +         opp_throw_ins + opp_save_percentage +              opp_red_cards , data = df,                         prior= "g-prior",alpha= n,
    n.models= 2^p, initprobs= "Uniform")
    
    summary = data.frame(summary(Data_bas))[2:(p+1),]

    variables = row.names(summary)[summary[,1] > threshold]
    
    return(variables)

}


```


```{r}
adjust_goal_differential = function(train, test, threshold){
  
set.seed(17)
  
variables = select_variables(train, threshold)
  
n_train = nrow(train)
    
n_test = nrow(test)

prop = n_train/(n_train + n_test)

data_gd = bind_rows(train,test)

split = initial_time_split(data_gd[,c("goal_differential",variables)], prop = prop)
train = training(split)
test = testing(split)

folds =  vfold_cv(train)

rf_model = rand_forest(mtry = tune(), min_n = tune(), trees = 250) %>% 
  set_engine("ranger", importance = "impurity", num.threads = 4) %>% 
  set_mode("regression")

rf_workflow = workflow() %>%
  add_model(rf_model) %>%
  add_formula(goal_differential ~ .)

rf_final = rf_workflow %>% 
  tune_grid(
    resamples = folds,
    grid = 25,
    control = control_grid(save_pred = TRUE),
    metrics = metric_set(rmse)
  ) %>%
  select_best("rmse")

final_wf = rf_workflow %>%
  finalize_workflow(rf_final) %>%
  last_fit(split)

preds_rf = final_wf %>%
  collect_predictions()

return(preds_rf$.pred)

}


```

```{r}
run_goal_diff_model = function(data, threshold, league){
  
  train  = data.frame()
  
  if(league == "womens"){
    lower = 1
    upper = (length(data)/2) - 1
  }
  else{
    lower = (length(data)/2) + 1
    upper = length(data) - 1
  }
 
  for(i in lower:upper){
    
  if(i == lower + 1){
  
     train$pred_goal_differential = 0
     data[[i-1]]$pred_goal_differential = 0
  }
  
  train = rbind(train, data[[i]])
  
  test = data[[i+1]]
  
  pred_goal_diff = adjust_goal_differential(train,test,threshold)
  
  if(length(pred_goal_diff) > nrow(test)){
    
    pred_goal_diff = tail(pred_goal_diff, n = nrow(test))
    
  }
  
  data[[i+1]]$pred_goal_differential = pred_goal_diff
  
  
  
  }
  
  return(data)
  
}



adjusted_womens_gds = run_goal_diff_model(data, 0.4, "womens")
adjusted_mens_gds = run_goal_diff_model(data,0.4,"mens")

data[1:3] = adjusted_womens_gds[1:3]
data[4:6] = adjusted_mens_gds[4:6]
```


```{r}
create_ratings = function(data, hyperparameters, last_year_ratings = NULL){
  
  df = data
  
  season_year = df$season_year[1]
  
  initial_vol = hyperparameters[1]
  vol_param = hyperparameters[2]
  he_param = hyperparameters[3]
  gd_param = hyperparameters[4]
  sd_param = hyperparameters[5]
  update_param = hyperparameters[6]
  
  df$rating = 0
  df$prior_rating = 0
  df$opp_prior_rating = 0
  df$win_probability = 0
  df$offensive_rating = 1
  df$defensive_rating = 1
  df$prior_off_rating = 1
  df$prior_def_rating = 1
  df$opp_prior_off_rating = 1
  df$opp_prior_def_rating = 1
  df$update_size = 0
  df$prior_update_size = 0
  df$volatility = initial_vol
  df$prior_volatility = initial_vol
  df$opp_prior_volatility = initial_vol
  df$volatility_update_size = 0

    for(j in 1:nrow(df)){
  
    team = df$team_market.x[j]
    
    game_number = df$team_game_number[j]
                                      
    opponent = df$team_market[j] 
    
    opponent_game_number =   df$opponent_team_game_number[j]

if(game_number > 1){
    
  indices = which(df$team_market.x == df$team_market.x[j])

    index = indices[as.integer(game_number-1)]

    prior_rating = df$rating[index]
    
    df$prior_rating[j] = prior_rating
    
    prior_volatility = df$volatility[index]
    
    df$prior_volatility[j] = prior_volatility
    
    prior_update_size = df$update_size[index]
    
    df$prior_update_size[j] = prior_update_size
    
    prior_offensive_rating = df$offensive_rating[index]
    
    df$prior_off_rating[j] = prior_offensive_rating
    
    prior_defensive_rating = df$defensive_rating[index]
    
    df$prior_def_rating[j] = prior_defensive_rating
}


    
if(game_number == 1 & season_year == 2020){
    prior_rating = 0
    prior_volatility = initial_vol
    prior_update_size = 0
    prior_offensive_rating = 1
    prior_defensive_rating = 1
    }
    
if(game_number == 1 & season_year != 2020){
    index = which(last_year_ratings$team_market.x == team)
    if(length(index)==0){
      prior_rating = 0
    }
    else{
    prior_rating = last_year_ratings$final_rating[index]
    df$prior_rating[j] = prior_rating}
    prior_offensive_rating = 1
    prior_volatility = initial_vol
    prior_defensive_rating = 1
    prior_update_size = 0}

if(opponent_game_number > 1){
    
    opponent_indices = which(df$team_market.x == df$team_market[j])

    opponent_index = opponent_indices[as.integer(opponent_game_number-1)]

    opponent_prior_rating = df$rating[opponent_index]
    
    df$opp_prior_rating[j] = opponent_prior_rating
    
    opponent_prior_volatility = df$volatility[opponent_index]
    
    df$opp_prior_volatility[j] = opponent_prior_volatility
    
    opponent_prior_offensive_rating = df$offensive_rating[opponent_index]
    
    opponent_prior_defensive_rating = df$defensive_rating[opponent_index]
    
    df$opp_prior_off_rating[j] = opponent_prior_offensive_rating
    
    df$opp_prior_def_rating[j] = opponent_prior_defensive_rating
    
    }
   
if(opponent_game_number == 1 & season_year == 2020){
    opponent_prior_rating = 0
    opponent_prior_volatility = initial_vol
    opponent_prior_offensive_rating = 1
    opponent_prior_defensive_rating = 1
}
    
    if(opponent_game_number == 1 & season_year != 2020){
    opponent_index = which(last_year_ratings$team_market.x == opponent)
    if(length(opponent_index)==0){
      opponent_prior_rating = 0
    }
    else{
    opponent_prior_rating = last_year_ratings$final_rating[opponent_index]
    df$opp_prior_rating[j] = opponent_prior_rating
    }
      opponent_prior_volatility = initial_vol
      opponent_prior_offensive_rating = 1
      opponent_prior_defensive_rating = 1}
  
    result = df$result[j]

  if(df$location_type[j]=="HOME"){
       
    win_probability = pnorm(prior_rating+he_param - opponent_prior_rating , mean = 0, sd = sqrt(prior_volatility^2 + opponent_prior_volatility^2))
       
    grad = update_ratings(result,prior_rating+he_param,opponent_prior_rating, prior_volatility,opponent_prior_volatility)
    
    volatility_grad = update_volatility(result,prior_rating+he_param,opponent_prior_rating, prior_volatility,opponent_prior_volatility)
}

  if(df$location_type[j] == "AWAY"){
     
    win_probability = pnorm(prior_rating - opponent_prior_rating - he_param, mean = 0, sd = sqrt(prior_volatility^2 + opponent_prior_volatility^2))
     
    grad = update_ratings(result,prior_rating,opponent_prior_rating+he_param, prior_volatility,opponent_prior_volatility)
    
     volatility_grad = update_volatility(result,prior_rating,opponent_prior_rating+he_param, prior_volatility,opponent_prior_volatility)
}

 
  if(df$location_type[j] == "NEUTRAL"){
     
    win_probability = pnorm(prior_rating - opponent_prior_rating, mean = 0, sd = sqrt(prior_volatility^2 + opponent_prior_volatility^2))
     
    grad = update_ratings(result,prior_rating,opponent_prior_rating,prior_volatility,opponent_prior_volatility)
}
  
  df$win_probability[j] = win_probability
  
  if(abs(df$goal_differential[j])<=1 & season_year == 2020){
  goal_diff = abs(df$goal_differential[j])}
  
  if(abs(df$goal_differential[j])>1 & season_year == 2020){
  goal_diff = sqrt(abs(df$goal_differential[j]))
  }
  
  if(abs(df$pred_goal_differential[j])<=1 & season_year != 2020){
  goal_diff = abs(df$pred_goal_differential[j])}
  
  if(abs(df$pred_goal_differential[j])>1 & season_year != 2020){
  goal_diff = sqrt(abs(df$pred_goal_differential[j]))
  }
  
  shots_diff = sqrt(abs(df$diff_in_shots[j]))
  
  ratings_diff = prior_rating - opponent_prior_rating
  
  if(goal_diff != 0){
  update = (gd_param*goal_diff + sd_param*shots_diff)*grad + update_param*prior_update_size
  }
  
  if(goal_diff == 0){
   update = (gd_param*0.25 + sd_param*shots_diff)*grad + update_param*prior_update_size 
  }
  
  if(update < 0){
    
    update_size = max(c(update,-1))
    
    df$rating[j] = prior_rating +
      update_size
  }
  
  if(update >= 0){
    
    update_size = min(c(update,1))
    
    df$rating[j] = prior_rating +
      update_size
  }
  
  df$update_size[j] = update_size
  
  volatility_update_size = vol_param*volatility_grad
  
  df$volatility_update_size[j] = volatility_update_size
  
  df$volatility[j] = prior_volatility + volatility_update_size
                                 
  goals_scored = df$goals[j]
  
  goals_allowed = df$opp_goals[j]
  
  offensive_update = (sqrt(prior_offensive_rating* opponent_prior_defensive_rating) + goals_scored)/2
  
  df$offensive_rating[j] = offensive_update
  
  defensive_update= (sqrt(prior_defensive_rating*opponent_prior_offensive_rating) + goals_allowed)/2
  
  df$defensive_rating[j] = defensive_update
  
    }
 return(df) 

}

```
 

```{r}

find_final_ratings = function(data){
  
final_ratings = data %>%
  group_by(team_market.x) %>%
  summarise(n=n())

final_ratings$final_rating = 0
  
for(j in 1:nrow(final_ratings)){
  for(i in 1:nrow(data)){
    if(final_ratings$team_market.x[j] == data$team_market.x[i] & final_ratings$n[j] == data$team_game_number[i]){
     
  final_ratings$final_rating[j] = data$rating[i]
      
    }
  }
}

 final_ratings = final_ratings %>%
  arrange(desc(final_rating))

 return(final_ratings)

}
```


```{r}
find_final_volatility = function(data){
  
final_ratings = data %>%
  group_by(team_market.x) %>%
  summarise(n=n())

final_ratings$final_volatility = 0
  
for(j in 1:nrow(final_ratings)){
  for(i in 1:nrow(data)){
    if(final_ratings$team_market.x[j] == data$team_market.x[i] & final_ratings$n[j] == data$team_game_number[i]){
     
  final_ratings$final_volatility[j] = data$volatility[i]
      
    }
  }
}

 final_ratings = final_ratings %>%
  arrange(desc(final_volatility))

 return(final_ratings)

}
```


```{r}
find_ranks = function(data,day){
  
  df = data
  
  df$date = as.Date(df$date)
  
  df = df[df$date <= day,]
  
  ratings = df %>%
  group_by(team_market.x, team_conference_id) %>%
  summarise(n=n())
  
  ratings$rating = 0
  
for(j in 1:nrow(ratings)){
  for(i in 1:nrow(df)){
    if(ratings$team_market.x[j] == df$team_market.x[i] & ratings$n[j] == df$team_game_number[i]){
     
  ratings$rating[j] = df$rating[i]
      
    }
  }
}

 ratings = ratings %>%
  ungroup() %>%
  arrange(desc(rating)) %>%
  mutate(rank = 1:nrow(ratings))
 
 return(ratings)
  
}


```
 
 
```{r}
tune_hyperparameters = function(data,  gd_scale = c(0.75,1,1.25), last_year_ratings = NULL,sd_scale = c(0.5,0.25,0.1),  home_effect = c(0.2,0.3,0.4), vol_scale = c(1.25,1.5,1.75), vol_step = c(0.5,0.75,1), update_scale = c(0.05,0.1,0.2)){
  
  df = data
  
  three_way_results = c()
  two_way_results = c()
  brier_scores = c()
  mses = c()
  hypers = c()
  

for(v in 1:length(vol_scale)){
  
for(s in 1:length(vol_step)){
  
for(h in 1:length(home_effect)){
  
for(k in 1:length(gd_scale)){
    
for(m in 1:length(sd_scale)){
  
for(b in 1:length(update_scale)){
  
  hyperparameters = c(vol_scale[v], vol_step[s], home_effect[h], gd_scale[k], sd_scale[m], update_scale[b])
  
  df = create_ratings(df,hyperparameters,last_year_ratings)
    
  performance = get_performance_measures(df)
  
  three_way_results = c(three_way_results,performance[1])
  two_way_results = c(two_way_results,performance[2])
  brier_scores = c(brier_scores,performance[3])
  mses = c(mses, performance[4])
  hypers = c(hypers,paste0(v,s,h,k,m,b))
  
 
 print(v)
  
  }
}}}}}
  
  results = list(twoway = two_way_results,threeway = three_way_results, brier = brier_scores,mses = mses,hyperparameters = hypers)
  
  hyper_index = which.min(results[["mses"]])
  
  tuning_indices = results[["hyperparameters"]][hyper_index]
  
  params_indices = as.integer(strsplit(tuning_indices, split = "")[[1]])
  
initial_vol = vol_scale[params_indices[1]]
  
vol_param = vol_step[params_indices[2]]

he_param = home_effect[params_indices[3]]

gd_param = gd_scale[params_indices[4]]

sd_param = sd_scale[params_indices[5]]

update_param = update_scale[params_indices[6]]

hyperparameters = c(initial_vol,vol_param,he_param,gd_param,sd_param,update_param)
  
  return(list(best = hyperparameters,results = results))  
}

```
 

```{r}
get_performance_measures = function(data){
  
  df = data
  
  df = df %>%
  mutate(pred_result = case_when(
    win_probability >= 0.48 & win_probability <= 0.52 ~ "0.5",
    win_probability > 0.52 ~ "1",
    win_probability < 0.48 ~ "0"
  ),
        pred_score_margin = prior_rating -            opp_prior_rating)

   df$pred_result = as.numeric(df$pred_result)

three_way_results = mean(df$pred_result == df$result)

  df_filter = df %>%
  filter(result != 0.5) %>%
  mutate(pred_result = ifelse(win_probability>=0.5,1,0))

two_way_results = mean(df_filter$pred_result == df_filter$result)

brier_score = mean((df_filter$win_probability - df_filter$result)^2)

mse = sqrt(mean((df$goal_differential - df$pred_score_margin)^2))
  
return(c(three_way_results,two_way_results,brier_score,mse))
  
}

```

```{r}
run_ratings_model = function(data, league){
  
  if(league == "womens"){
    lower = 1
    upper = (length(data)/2) - 1
  }
  else{
    lower = (length(data)/2) + 1
    upper = length(data) - 1
  }
  
  for(i in lower:upper){
    
    if(i != lower){
      
      hyperparameters = tune_hyperparameters(data[[i]], final_ratings)
    
    }
    
    if(i == lower){
      
    hyperparameters = tune_hyperparameters(data[[i]])
    
     data[[i]] =  create_ratings(data[[i]], hyperparameters$best)
     
     final_ratings = find_final_ratings(data[[i]])
    }
    
    data[[i+1]] = create_ratings(data[[i+1]], hyperparameters$best, final_ratings)
    
    final_ratings = find_final_ratings(data[[i+1]])
  }
    
   return(data) 
}

```

```{r}
predict_score_margin = function(data, alpha){
  
  for(i in 1:length(data)){
    
    df = data[[i]]
    
    df = df %>%
      mutate(pred_score_margin = 
               prior_rating - opp_prior_rating) %>%
      mutate(pred_score_margin_lower = 
pred_score_margin - qnorm(1 - (alpha/2))*sqrt(prior_volatility^2 + opp_prior_volatility^2),
             pred_score_margin_upper = 
pred_score_margin + qnorm(1 - (alpha/2))*sqrt(prior_volatility^2 + opp_prior_volatility^2)
)
    
    
  data[[i]] = df  
    
  }
 
  return(data)
}

complete_model = predict_score_margin(complete_model, 0.05)

```

```{r}
df_2022$pred_goal_diff = df_2022$prior_rating - df_2022$opp_prior_rating

df_2022$opp_rating = df_2022$opp_prior_rating - df_2022$update_size

compare = data.frame(true = womens_model_2022$goal_differential, pred = df_2022$pred_goal_diff)
mean(abs(compare$true - compare$pred))
ggplot(data = compare, aes(x = true, y = pred))+
  geom_point()+
  theme_classic()+
  geom_smooth()
preds = c()
for(i in -5:5){
temp = compare %>%
  filter(true == i) %>%
  summarise(mean = mean(pred))
preds = c(preds, temp$mean[1])
}
```


```{r}
ggplot(data = df_2022, aes(x = abs(update_size)))+
  geom_density(fill = "orange")+
  theme_classic()
x = seq(-5,5,length.out = 2000)
y = 10/(x + 10)
plot(x,y,type = "l")
```


```{r}
accuracy_over_time_2020 = c()
for(i in 1:max(womens_model_2020_filter$team_game_number)){
  df = womens_model_2020_filter %>%
    filter(team_game_number == i)
  pred = mean(df$pred_result == df$result)
  accuracy_over_time_2020 = c(accuracy_over_time_2020,pred)
}
accuracy_over_time_2021 = c()
for(i in 1:max(womens_model_2021_filter$team_game_number)){
  df = womens_model_2021_filter %>%
    filter(team_game_number == i)
  pred = mean(df$pred_result == df$result)
  accuracy_over_time_2021 = c(accuracy_over_time_2021,pred)
}

accuracy_over_time_2022 = c()
for(i in 1:max(womens_model_2022_filter$team_game_number)){
  df = womens_model_2022_filter %>%
    filter(team_game_number == i)
  pred = mean(df$pred_result == df$result)
  accuracy_over_time_2022 = c(accuracy_over_time_2022,pred)
}

```

```{r}
accuracy_over_time_2020 = c()
for(i in 1:max(mens_model_2020_filter$team_game_number)){
  df = mens_model_2020_filter %>%
    filter(team_game_number == i)
  pred = mean(df$pred_result == df$result)
  accuracy_over_time_2020 = c(accuracy_over_time_2020,pred)
}
accuracy_over_time_2021 = c()
for(i in 1:max(mens_model_2021_filter$team_game_number)){
  df = mens_model_2021_filter %>%
    filter(team_game_number == i)
  pred = mean(df$pred_result == df$result)
  accuracy_over_time_2021 = c(accuracy_over_time_2021,pred)
}

accuracy_over_time_2022 = c()
for(i in 1:max(mens_model_2022_filter$team_game_number)){
  df = mens_model_2022_filter %>%
    filter(team_game_number == i)
  pred = mean(df$pred_result == df$result)
  accuracy_over_time_2022 = c(accuracy_over_time_2022,pred)
}
accuracy_over_time_2020
```


```{r}
mistakes_2021 = womens_model_2021_filter %>%
  filter(pred_result != result)

ggplot(data = mistakes_2021, aes(x = win_probability))+
  geom_histogram(binwidth = 0.1)
```

```{r}
womens_model_2021_filter %>%
  mutate(correct = factor(ifelse(result==pred_result,1,0)))%>%
  ggplot(aes(x = opp_prior_rating,group = correct, col=correct)) + 
  geom_density() +
  theme_classic() +
  scale_color_manual(values = c("red","blue"))
```
```{r}
womens_model_2021_filter %>%
   mutate(correct = ifelse(result==pred_result,1,0)) %>%
  group_by(correct)%>%
  summarise(mean = mean(offensive_rating))
```

```{r}

womens_model_2021$pred_result = factor(womens_model_2021$pred_result)
womens_model_2021$result = factor(womens_model_2021$result)
confusionMatrix(womens_model_2021$result, womens_model_2021$pred_result)
```

Adjust by square root of goal differential and win probability is logistic function with difference divided by 0.5. [0.48,0.52] threshold for draws.

2020: 65.3% w/o draws, 57.6% w/ draws
2021: 68.5% w/o draws, 60.7% w/ draws
2022: 70.7% w/o draws, 55.2% w/ draws

Logistic function with parameter 2 not interpretable. Values range from [-9,9]

Change win probability to probit function with standard deviation of 1.5

2020: 66.1 % w/o draws, 58.6% w/ draws
2021: 69.6 % w/o draws, 61.8% w/ draws
2022: 71.9 % w/o draws, 56.4% w/ draws

Adjust further to standard deviation of 2 for probit

2020: 66.2 % w/o draws, 58.7% w/ draws
2021: 69.8 % w/o draws, 62.0% w/ draws
2022: 72.4 % w/o draws, 56.1% w/ draws

Adjust by square root of goal differential divided by 2

2020: 66.4% w/o draws, 58.6% w/ draws
2021: 70.2% w/o draws, 61.9% w/ draws
2022: 72.4% w/o draws, 56.8% w/ draws

Home effect of 0.25

2020: 67.4% w/o draws, 59.2% w/ draws
2021: 71.4% w/o draws, 63.1% w/ draws
2022: 73.0% w/o draws, 57.0% w/ draws

Home effect of 0.5
Worse across the board

Home effect of 0.35
2020: 69.4% w/o draws, 60.7% w/ draws
2021: 71.1% w/o draws, 62.8% w/ draws
2022: 72.6% w/o draws, 56.7% w/ draws




55/64 teams for tournament projections


```{r}
create_offensive_and_defensive_stats = function(data){

for(i in 1:length(data)){ 
 
df = data[[i]] 

df = df %>%
  group_by(team_market.x) %>%
  mutate(goal_avg = lag(cumsum(goals)/team_game_number,1),
         shots_avg = lag(cumsum(shots)/team_game_number,1),
          corners_avg = lag(cumsum(corners)/team_game_number,1),
          offsides_avg = lag(cumsum(offsides)/team_game_number,1),
          shots_on_target_pct_avg = lag(cumsum(shots_on_target_percentage)/team_game_number,1),
         shots_saved_avg = lag(cumsum(shots_saved)/team_game_number,1),
         save_pct_avg = lag(cumsum(save_percentage)/team_game_number,1),
         goal_kicks_avg = lag(cumsum(goal_kicks)/team_game_number,1),
         prior_goals_1 = lag(goals,1),
         prior_goals_2 = lag(goals,2),
         prior_shots_1 = lag(shots,1),
         prior_shots_2 = lag(shots,2),
         prior_corners_1 = lag(corners,1),
         prior_corners_2 = lag(corners,2),
         prior_offsides_1 = lag(offsides,1),
         prior_offsides_2 = lag(offsides,2),
         prior_shots_on_target_pct_1 = lag(shots_on_target_percentage,1),
         prior_shots_on_target_pct_2 = lag(shots_on_target_percentage,2),
         prior_shots_saved_1 = lag(shots_saved,1),
         prior_shots_saved_2 = lag(shots_saved,2),
         prior_save_percentage_1 = lag(save_percentage,1),
         prior_save_percentage_2 = lag(save_percentage,2),
         prior_goal_kicks_1 = lag(goal_kicks,1),
         prior_goal_kicks_2 = lag(goal_kicks,2)
) %>%
  ungroup()

df = df %>%
  group_by(team_market) %>%
  mutate(opp_goal_avg = 
lag(cumsum(opp_goals)/opponent_team_game_number,1),
         opp_shots_avg = lag(cumsum(opp_shots)/opponent_team_game_number,1),
          opp_corners_avg = lag(cumsum(opp_corners)/opponent_team_game_number,1),
          opp_offsides_avg = lag(cumsum(opp_offsides)/opponent_team_game_number,1),
          opp_shots_on_target_pct_avg = lag(cumsum(opp_shots_on_target_percentage)/opponent_team_game_number,1),
          opp_shots_saved_avg = lag(cumsum(opp_shots_saved)/opponent_team_game_number,1),
          opp_save_pct_avg = lag(cumsum(opp_save_percentage)/opponent_team_game_number,1),
         opp_goal_kicks_avg = lag(cumsum(opp_goal_kicks)/opponent_team_game_number,1),
         rating_avg_opp = cumsum(opp_prior_rating)/opponent_team_game_number,
         opp_rating_avg_opp = cumsum(prior_rating)/opponent_team_game_number,
         opp_prior_goals_1 = lag(opp_goals,1),
         opp_prior_goals_2 = lag(opp_goals,2),
         opp_prior_shots_1 = lag(opp_shots,1),
         opp_prior_shots_2 = lag(opp_shots,2),
         opp_prior_corners_1 = lag(opp_corners,1),
         opp_prior_corners_2 = lag(opp_corners,2),
         opp_prior_offsides_1 = lag(opp_offsides,1),
         opp_prior_offsides_2 = lag(opp_offsides,2),
         opp_prior_shots_on_target_pct_1 = lag(opp_shots_on_target_percentage,1),
         opp_prior_shots_on_target_pct_2 = lag(opp_shots_on_target_percentage,2),
         opp_prior_shots_saved_1 = lag(opp_shots_saved,1),
         opp_prior_shots_saved_2 = lag(opp_shots_saved,2),
         opp_prior_save_percentage_1 = lag(opp_save_percentage,1),
         opp_prior_save_percentage_2 = lag(opp_save_percentage,2),
         opp_prior_goal_kicks_1 = lag(opp_goal_kicks,1),
         opp_prior_goal_kicks_2 = lag(opp_goal_kicks,2)
) %>%
  ungroup()
 data[[i]] = df
}
  return(data)
}

complete_model = create_offensive_and_defensive_stats(complete_model)

```

```{r}
opponent_variables = c("opp_prior_rating", "opp_prior_off_rating", "opp_prior_def_rating", "opp_goal_avg", "opp_shots_avg","opp_corners_avg", "opp_offsides_avg", "opp_shots_on_target_pct_avg",
"opp_shots_saved_avg", "opp_save_pct_avg", "opp_goal_kicks_avg", "rating_avg_opp", "opp_rating_avg_opp", "opp_prior_goals_1", "opp_prior_goals_2", "opp_prior_shots_1" , "opp_prior_shots_2" , "opp_prior_corners_1", 
"opp_prior_corners_2", "opp_prior_offsides_1",
"opp_prior_offsides_2", "opp_prior_shots_on_target_pct_1",
"opp_prior_shots_on_target_pct_2", "opp_prior_shots_saved_1", "opp_prior_shots_saved_2", 
"opp_prior_save_percentage_1",
"opp_prior_save_percentage_2",
"opp_prior_goal_kicks_1",
"opp_prior_goal_kicks_2")

team_variables = c("prior_rating", "prior_off_rating", "prior_def_rating", "goal_avg",
"shots_avg", "corners_avg", "offsides_avg", 
"shots_on_target_pct_avg", "shots_saved_avg", 
"save_pct_avg", "goal_kicks_avg", "prior_goals_1", 
"prior_goals_2", "prior_shots_1", "prior_shots_2", 
"prior_corners_1", "prior_corners_2", "prior_offsides_1", "prior_offsides_2",  
"prior_shots_on_target_pct_1",  "prior_shots_on_target_pct_2","prior_shots_saved_1","prior_shots_saved_2","prior_save_percentage_1",  
"prior_save_percentage_2", "prior_goal_kicks_1",
         "prior_goal_kicks_2")
```




```{r}
create_historical_stats = function(data){

hist = list()  
  
for(j in 1:length(data)){  
  
  df = data[[j]]
  
  df$date = as.Date(df$date)
  
  dates = unique(df$date)
  
  hist_df = data.frame()
  
  for(i in 1:length(dates)){
    
     temp_data = df[df$date < dates[i],]
    
    historical_stats = temp_data %>%
          summarise_at(.vars = opponent_variables, mean, na.rm = TRUE)
    
    historical_stats$date = dates[i]
    
    hist_df = rbind(hist_df,historical_stats)
  }
   hist_df = na.omit(hist_df)
   hist[[j]] = hist_df
} 
   return(hist)
}

historical_stats = create_historical_stats(complete_model)

```


```{r}
apply_exponential_smoothing = function(data,alpha){
  
  split_dfs = split(data,data$team_market.x)
  
  for(i in 1:length(split_dfs)){
    
    df = split_dfs[[i]]
    
df$exp_smooth_off_rating = df$new_offensive_rating
df$exp_smooth_def_rating = df$new_defensive_rating
  
  if(nrow(df) > 1){
    for(j in 2:nrow(df)){
    
    if(df$new_offensive_rating[j-1] != 0){
    
    df$exp_smooth_off_rating[j] =  (1-alpha)*df$exp_smooth_off_rating[j-1] + alpha*df$new_offensive_rating[j]}
      
    if(df$new_defensive_rating[j-1] != 0){
    
    df$exp_smooth_def_rating[j] =  (1-alpha)*df$exp_smooth_def_rating[j-1] + alpha*df$new_defensive_rating[j]}
    
      }}

  split_dfs[[i]] = df
}

data = bind_rows(split_dfs)%>%
  arrange(date)

  return(data)
}

```






```{r}
create_offensive_defensive_ratings = function(prior_year_data, data, type, historical_data){ 
  
  df = data %>%
  dplyr::select(-all_of(opponent_variables))
  
  df = left_join(df, historical_data, by = "date") %>%
    arrange(date)
  
  model_full = df[complete.cases(df), ]
  model_nas = df[!complete.cases(df), ]
  model_df = na.omit(rbind(prior_year_data,
                           model_full)) 
  current_year = data$season_year[1]
  prop = 1 - mean(model_df$season_year == current_year)

  split = initial_time_split(model_df[,c("location_type","goals","opp_goals",team_variables, opponent_variables)], prop = prop)
  train = training(split)
  test = testing(split)
  folds =  vfold_cv(train)

rf_model = rand_forest(mtry = tune(), min_n = tune(), trees = 250) %>% 
  set_engine("ranger", importance = "impurity", num.threads = 4) %>% 
  set_mode("regression")

if(type == "offensive"){
rf_workflow = workflow() %>%
  add_model(rf_model) %>%
  add_formula(goals ~ .)}

else{
rf_workflow = workflow() %>%
  add_model(rf_model) %>%
  add_formula(opp_goals ~ .)}

rf_res = rf_workflow %>% 
  tune_grid(
    resamples = folds,
    grid = 25,
    control = control_grid(save_pred = TRUE),
    metrics = metric_set(rmse)
  )

rf_final = rf_res %>%
  select_best("rmse")

final_wf = rf_workflow %>%
  finalize_workflow(rf_final)

final_fit = final_wf %>%
  last_fit(split)

preds = final_fit %>%
  collect_predictions()

if(type == "offensive"){
  model_full$new_offensive_rating = preds$.pred
  model_nas$new_offensive_rating = 0
}

else{
  
  model_full$new_defensive_rating = preds$.pred
  model_nas$new_defensive_rating = 0
}

  ret = rbind(model_full,model_nas) %>%
    arrange(date)
  if(type == "offensive"){
  
    return(ret$new_offensive_rating)}
  
  else{
    
    return(ret$new_defensive_rating)}
}
```

```{r}
run_offensive_defensive_model = function(data, league, alpha){
  
historical_stats = create_historical_stats(data)
 
train  = data.frame() 

if(league == "womens"){
    lower = 1
    upper = (length(data)/2) - 1
  }
else{
    lower = (length(data)/2) + 1
    upper = length(data) - 1
  }
  
for(i in lower:upper){
    
    if(i == lower + 1){
  
     train$new_offensive_rating = 0
     train$new_defensive_rating = 0
  }
  
  train = rbind(train, data[[i]])
  
  test = data[[i+1]]
  
  off_rating = create_offensive_defensive_ratings(
  train,test,"offensive",historical_stats[[i+1]])
  
  def_rating = create_offensive_defensive_ratings(
  train,test,"defensive",historical_stats[[i+1]])
  
  data[[i+1]]$new_offensive_rating = off_rating
  data[[i+1]]$new_defensive_rating = def_rating
  
  data[[i+1]] = apply_exponential_smoothing(data[[i+1]],alpha)
  
  }
  
  return(data)
}
    
```

```{r}
womens_2021_ratings = create_offensive_defensive_ratings(prior_year_data = complete_model[[1]], data = complete_model[[2]],type = "offensive", historical_data = historical_stats[[2]])

womens_2021_ratings = apply_off_exponential_smoothing(womens_2021_ratings,0.2)

final_off_womens_2021 = find_final_off_ratings(womens_2021_ratings)
```


```{r}
mens_2021_ratings = create_offensive_defensive_ratings(prior_year_data = complete_model[[4]], data = complete_model[[5]],type = "offensive", historical_data = historical_stats[[5]])

mens_2021_ratings = apply_off_exponential_smoothing(mens_2021_ratings,0.2)

final_off_mens_2021 = find_final_off_ratings(mens_2021_ratings)

womens_2022_ratings = create_offensive_defensive_ratings(prior_year_data = rbind(complete_model[[1]],complete_model[[2]]), data = complete_model[[3]],type = "offensive", historical_data = historical_stats[[3]])

womens_2022_ratings = apply_off_exponential_smoothing(womens_2022_ratings,0.2)

final_off_womens_2022 = find_final_off_ratings(womens_2022_ratings)

mens_2022_ratings = create_offensive_defensive_ratings(prior_year_data = rbind(complete_model[[4]],complete_model[[5]]), data = complete_model[[6]],type = "offensive", historical_data = historical_stats[[6]])

mens_2022_ratings = apply_off_exponential_smoothing(mens_2022_ratings,0.2)

final_off_mens_2022 = find_final_off_ratings(mens_2022_ratings)
```

```{r}
womens_2021_def_ratings = create_offensive_defensive_ratings(prior_year_data = complete_model[[1]], data = complete_model[[2]],type = "defensive", historical_data = historical_stats[[2]])

womens_2021_def_ratings = apply_def_exponential_smoothing(womens_2021_def_ratings, 0.1)

final_def_womens_2021 = find_final_def_ratings(womens_2021_def_ratings)

mens_2021_def_ratings = create_offensive_defensive_ratings(prior_year_data = complete_model[[4]], data = complete_model[[5]],type = "defensive", historical_data = historical_stats[[5]])

mens_2021_def_ratings = apply_def_exponential_smoothing(mens_2021_def_ratings, 0.1)

final_def_mens_2021 = find_final_def_ratings(mens_2021_def_ratings)
```


```{r}
womens_2022_def_ratings = create_offensive_defensive_ratings(prior_year_data = rbind(complete_model[[1]],complete_model[[2]]), data = complete_model[[3]],type = "defensive", historical_data = historical_stats[[3]])

womens_2022_def_ratings = apply_def_exponential_smoothing(womens_2022_def_ratings, 0.1)

final_def_womens_2022 = find_final_def_ratings(womens_2022_def_ratings)

mens_2022_def_ratings = create_offensive_defensive_ratings(prior_year_data = rbind(complete_model[[4]],complete_model[[5]]), data = complete_model[[6]],type = "defensive", historical_data = historical_stats[[6]])

mens_2022_def_ratings = apply_def_exponential_smoothing(mens_2022_def_ratings, 0.1)

final_def_mens_2022 = find_final_def_ratings(mens_2022_def_ratings)
```



```{r}

final_wf.w %>% 
  fit(temp_df[,c(13,15,36:38,41:44,47:96)]) %>% 
  extract_fit_parsnip() %>% 
  vip(num_features = 30)

gb_model.w = boost_tree(mtry = tune(), min_n = tune(), trees = 250) %>% 
  set_engine("xgboost", num.threads = 4) %>% 
  set_mode("regression")

```



```{r}
find_final_off_ratings = function(data){
  
final_ratings = data %>%
  group_by(team_market.x) %>%
  summarise(n=n())

final_ratings$final_off_rating = 0
  
for(j in 1:nrow(final_ratings)){
  for(i in 1:nrow(data)){
    if(final_ratings$team_market.x[j] == data$team_market.x[i] & final_ratings$n[j] == data$team_game_number[i]){
     
  final_ratings$final_off_rating[j] = data$exp_smooth_off_rating[i]
      
    }
  }
}

 final_ratings = final_ratings %>%
  arrange(desc(final_off_rating))

 return(final_ratings)

}


```


```{r}
find_final_def_ratings = function(data){
  
final_ratings = data %>%
  group_by(team_market.x) %>%
  summarise(n=n()) %>%
  filter(n>1)

final_ratings$final_def_rating = 0
  
for(j in 1:nrow(final_ratings)){
  for(i in 1:nrow(data)){
    if(final_ratings$team_market.x[j] == data$team_market.x[i] & final_ratings$n[j] == data$team_game_number[i]){
     
  final_ratings$final_def_rating[j] = data$exp_smooth_def_rating[i]
      
    }
  }
}

 final_ratings = final_ratings %>%
  arrange(final_def_rating)

 return(final_ratings)

}


```


```{r}

create_dashboard_data = function(data,dates){
  
   season_rankings = find_season_rankings(data,dates) 
  
  data = data %>%
    group_by(team_market.x)%>%
    summarise(number_matches=n(),
            wins = sum(result ==1),
            draws = sum(result == 0.5),
            losses = sum(result == 0),
            total_goals = sum(goals))
  
   data = left_join(season_rankings, data,  by =    "team_market.x")

   return(data)

}

dashboard_data_womens_2021 = create_dashboard_data(womens_model_2021, rankings_dates_womens_2021)

dashboard_data_mens_2021 = create_dashboard_data(mens_model_2021, rankings_dates_mens_2021)

dashboard_data_womens_2020 = create_dashboard_data(womens_model_2020, rankings_dates_womens_2020)

dashboard_data_mens_2020 = create_dashboard_data(mens_model_2020, rankings_dates_mens_2020)

dashboard_data_womens_2022 = create_dashboard_data(womens_model_2022, rankings_dates_womens_2022)

dashboard_data_mens_2022 = create_dashboard_data(mens_model_2022, rankings_dates_mens_2022)

write.csv(dashboard_data_mens_2020, "C:/Users/Owner/Documents/dashboard_mens_2020.csv", row.names = FALSE)

write.csv(dashboard_data_womens_2020, "C:/Users/Owner/Documents/dashboard_womens_2020.csv", row.names = FALSE)

write.csv(dashboard_data_mens_2021, "C:/Users/Owner/Documents/dashboard_mens_2021.csv", row.names = FALSE)

write.csv(dashboard_data_womens_2021, "C:/Users/Owner/Documents/dashboard_womens_2021.csv", row.names = FALSE)

write.csv(dashboard_data_mens_2022, "C:/Users/Owner/Documents/dashboard_mens_2022.csv", row.names = FALSE)

write.csv(dashboard_data_womens_2022, "C:/Users/Owner/Documents/dashboard_womens_2022.csv", row.names = FALSE)
```


```{r}


rankings_comparison_womens_2021 = data.frame(
  
  true_rankings = c("Florida St.", "BYU", "Rutgers", "Santa Clara", "Duke", "Arkansas", "Michigan", "Virginia", "TCU", "South Carolina", "Tennessee","Southern California", "Pepperdine", "North Carolina", "UCLA", "Notre Dame", "Washington St.", "Ole Miss", "Xavier", "Memphis", "SMU", "Georgetown", "Penn State", "Purdue", "Wake Forest"),
  
  predicted_rankings = womens_2021_final_ratings$team_market.x[1:25]
  
)

rankings_comparison_mens_2021 = data.frame(
  
  true_rankings = c("Clemson", "Washington", "Georgetown", "Notre Dame", "Oregon St.", "Pittsburgh", "Saint Louis", "West Virginia", "New Hampshire", "Tulsa", "Kentucky", "Duke", "Hofstra", "Indiana", "Marshall", "Providence", "Wake Forest", "FIU", "Virginia Tech", "Santa Clara", "NIU", "Missouri St.", "Maryland", "Penn St.", "UCLA"),
  
  predicted_rankings = mens_2021_final_ratings$team_market.x[1:25]
  
)



write.csv(womens_2021_final_ratings,"C:/Users/Owner/Documents/womens_2021_final_ratings.csv")

write.csv(rankings_comparison_mens_2021,"C:/Users/Owner/Documents/rankings_comparison_mens_2021.csv")

write.csv(rankings_comparison_womens_2021,"C:/Users/Owner/Documents/rankings_comparison_womens_2021.csv")

write.csv(womens_model_2020,"C:/Users/Owner/Documents/womens_model_2020.csv")

write.csv(womens_model_2021,"C:/Users/Owner/Documents/womens_model_2021.csv")

write.csv(womens_model_2022,"C:/Users/Owner/Documents/womens_model_2022.csv")

write.csv(mens_model_2020,"C:/Users/Owner/Documents/mens_model_2020.csv")

write.csv(mens_model_2021,"C:/Users/Owner/Documents/mens_model_2021.csv")

write.csv(mens_model_2022,"C:/Users/Owner/Documents/mens_model_2022.csv")


```



```{r}
womens_2021_tournament_field = c("Bowling Green", "Brown", "Bucknell", "Central Conn. St.", "Florida St.", "Georgetown", "Grand Canyon", "High Point", "Hofstra", "Lipscomb", "Loyola Chicago", "Memphis","Michigan", "Milwaukee", "Monmouth", "Montana", "New Mexico", "Northwestern St.", "Old Dominion", "Prairie View", "Saint Louis", "Samford","Santa Clara", "SIUE", "South Alabama", "South Dakota St.", "TCU", "Tennessee", "UC Irvine", "UCLA", "Vermont", "Alabama", "Arkansas", "Auburn","Butler","BYU", "Clemson", "Duke", "Harvard", "LSU", "NC State", "North Carolina", "Notre Dame", "Ole Miss", "Ohio St.", "Penn St.", "Pepperdine", "Princeton", "Providence", "Purdue", "Rutgers", "SMU", "South Carolina", "South Fla.", "St. John's (NY)", "Stanford", "Texas", "Southern California", "Virginia", "Virginia Tech", "Wake Forest", "Washington St.", "Wisconsin", "Xavier")

mens_2021_tournament_field = c("Akron", "Bowling Green", "Campbell", "Charlotte", "Clemson", "Creighton", "Denver", "Duke", "FIU", "Georgetown", "Georgia St.", "Grand Canyon", "Hofstra", "Indiana", "Kentucky", "Lipscomb", "LIU", "Louisville", "Loyola Maryland", "Marist", "Marshall", "Maryland", "Mercer", "Missouri St.", "New Hampshire", "North Carolina", "NIU", "Notre Dame", "Oakland", "Oregon St.", "Penn St.", "Pittsburgh", "Portland", "Princeton", "Providence", "Saint Louis", "Santa Clara", "Seattle U", "St. John's (NY)", "Tulsa", "UC Santa Barbara", "UCLA", "Vermont", "Villanova", "Virginia Tech", "Wake Forest", "Washington", "West Virginia")
```


```{r}
find_conference_winners = function(rankings){
  
  conference_winners = rankings %>%
    group_by(team_conference_id) %>%
    summarise(best = max(rating))
  
  for(i in 1:nrow(conference_winners)){
  for(j in 1:nrow(rankings)){
  
    if(rankings$rating[j] == conference_winners$best[i]){
      
      conference_winners$team[i] = rankings$team_market.x[j]
  }
  } 
  }
  
  return(conference_winners$team)
}
```


```{r}
find_at_large_bids = function(rankings,conference_winners,league){
  
  drop_indices = which(rankings$team_market.x %in% conference_winners)
  
  at_large = rankings[-drop_indices, ]
  
  if(league == "mens"){
  n = 48 - length(conference_winners)}
  
  if(league == "womens"){
  n = 64 - length(conference_winners)}
  
  at_large_bids = at_large$team_market.x[1:n]
  
  return(at_large_bids)
}
```


```{r}
project_tournament_field = function(data, league, day){
  
  rankings = find_ranks(data,day)
  
  conference_winners = find_conference_winners(rankings)
  
  at_large_bids = find_at_large_bids(rankings,conference_winners,league)
  
  pred_field = c(conference_winners,at_large_bids)
  
  return(pred_field)
}

pred_field_men_2021 =project_tournament_field(mens_model_2021, "mens","2021-11-10")

length(which(pred_field_men_2021 %in% mens_2021_tournament_field))/48

sort(pred_field_men_2021)

mens_pre_tournament = find_ranks(mens_model_2021,"2021-11-10")
```


```{r}
rankings_dates_mens_2022 = c("2022-08-30", "2022-09-06", "2022-09-13", "2022-09-20", "2022-09-27", "2022-10-04", "2022-10-11")

rankings_dates_womens_2022 = c("2022-08-23", "2022-08-30", "2022-09-06", "2022-09-13", "2022-09-20", "2022-09-27", "2022-10-04", "2022-10-11")

rankings_dates_mens_2021 = c("2021-08-31", "2021-09-07", "2021-09-14", "2021-09-21", "2021-09-28", "2021-10-05", "2021-10-12", "2021-10-19", "2021-10-26", "2021-11-02", "2021-11-09", "2021-12-14")

rankings_dates_womens_2021 = c("2021-08-24", "2021-08-30", "2021-09-07", "2021-09-14", "2021-09-21", "2021-09-28", "2021-10-05", "2021-10-12", "2021-10-19", "2021-10-26", "2021-11-02", "2021-11-09", "2021-12-07")

rankings_dates_mens_2020 = c("2020-09-22", "2020-09-29", "2020-10-06", "2020-10-13", "2020-10-20", "2020-10-27", "2020-11-03", "2020-11-10", "2020-11-17", "2020-11-24",
"2021-03-02", "2021-03-09", "2021-03-16", "2021-03-23", "2021-03-30", "2021-04-06", 
"2021-04-13", "2021-04-20", "2021-05-18")

rankings_dates_womens_2020 = c("2020-09-22", "2020-09-29", "2020-10-06", "2020-10-13", "2020-10-20", "2020-10-27", "2020-11-03", "2020-11-10", "2020-11-17", "2020-11-24",
"2021-03-02", "2021-03-09", "2021-03-16", "2021-03-23", "2021-03-30", "2021-04-06", 
"2021-04-13", "2021-04-20", "2021-05-18")
```


```{r}
find_season_rankings = function(data,dates){
  
  df = data.frame()
  cols_rating = c()
  cols_rank = c()
  
  for(i in 1:length(dates)){
  
    ranks = find_ranks(data, dates[i])
    
    ranks = ranks[,c("team_market.x","rank","rating")]
    
    ranks$week_number = paste0("Poll ",i)
    
    df = rbind(df,ranks)
    
    cols_rank = c(cols_rank, paste0("Poll_Ranking_",i))
    
    cols_rating = c(cols_rating, paste0("Poll_Rating_",i))
  
  }
  
  df = df %>%
    pivot_wider(names_from = week_number, values_from = c(rank,rating))
  
  colnames(df) = c("team_market.x",cols_rank,cols_rating)
  
 return(df)
}

season_rankings_mens_2021 = find_season_rankings(mens_model_2021,rankings_dates_mens)

season_rankings_womens_2021 = find_season_rankings(womens_model_2021,rankings_dates_womens)

write.csv(season_rankings_mens_2021, "C:/Users/Owner/Documents/season_rankings_mens_2021.csv", row.names = FALSE)

write.csv(season_rankings_womens_2021, "C:/Users/Owner/Documents/season_rankings_womens_2021.csv", row.names = FALSE)

```





St. Louis is A10 champion 

Add South Alabama 

Drop Niagara, Monmouth is MAAC champion 

Drop Indiana St., Add Loyola Chicago 

Drop Rice, add Old Dominion 

No Alabama (68), LSU (35), NC State (47), Ohio St. (42), Providence (43), SMU (40), Wisconsin (56)

26-32 not in true field 

```{r}
auto_bids = auto_bids[!(auto_bids == "Hartford")]
auto_bids[11] = "Monmouth"
auto_bids[22] = "South Alabama"
auto_bids[18] = "Saint Louis"

```


Issue with choosing conference winners: conferences are 2022 alignment, not the 2021 alignment, so auto bids by conference differ for 2021 season, i.e. Rice is getting the auto bid that should go to Old Dominion.








